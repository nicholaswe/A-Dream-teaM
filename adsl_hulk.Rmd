---
title: "Admiral hackathon for Team Hulk"
output: html_document
date: "2023-02-14"
---

running the pharmaverse end-to-end ADSL example in blocks


  Kyle sign-in process...

  usethis::use_git_config(user.name = "kyleireton",
                          user.email = "kyle.ireton@gmail.com")

  gitcreds::gitcreds_set()

  Enter token: ghp_ #
  hXHuKYbIXE1eBQOaItxsA6sibH4Iqo1l2rQy

```{r load packages, data, include=FALSE}

options(repos = c(
  pharmaverse = 'https://pharmaverse.r-universe.dev',
  CRAN = 'https://cloud.r-project.org'))

library(metacore)
library(metatools)
library(admiral.test)
library(admiral)
library(xportr)
library(dplyr)
library(tidyr)
library(lubridate)
library(stringr)
library(haven)
library(readxl)

# Read in input SDTM data 
data("admiral_dm")
data("admiral_ex")

dm <- read_xpt("sdtm/dm.xpt")
ds <- read_xpt("sdtm/ds.xpt")
ex <- read_xpt("sdtm/ex.xpt")
vs <- read_xpt("sdtm/vs.xpt")
qs <- read_xpt("sdtm/qs.xpt")
mh <- read_xpt("sdtm/mh.xpt")
sv <- read_xpt("sdtm/sv.xpt")

my_spec <- read_xlsx("metadata/specs.xlsx", sheet = "Codelists")

```



```{r make functions}


format_eoxxstt_nodef <- function(x) {
  case_when(
    x == "COMPLETED" ~ "COMPLETED",
    TRUE ~ "DISCONTINUED"
  )
}

format_agegr1n <- function(x) {
  case_when(
    x < 65 ~ 1,
    x <= 80 ~ 2,
    x > 80 ~ 3
  )
}

format_agegr1 <- function(x) {
  case_when(
    x == 1 ~ "<65",
    x == 2 ~ "65-80",
    x == 3 ~ ">80"
  )
}

format_visnumen <- function(x) {
  case_when(
    x ==13 ~ 12,
    TRUE ~ x
  )
}


format_racen <- function(x) {
  case_when(
    x == "AMERICAN INDIAN OR ALASKA NATIVE" ~ 1,
    x == "ASIAN" ~ 2,
    x == "BLACK OR AFRICAN AMERICAN" ~ 3,
    x == "NATIVE HAWAIIAN OR OTHER PACIFIC ISLANDER" ~ 5,
    x == "WHITE" ~ 6,
    TRUE ~ 99
  )
}

# format_armn <- function(x) {
#   case_when(
#     x=="Placebo" ~ 0,
#     x=="Xanomeline Low Dose" ~ 1,
#     x=="Xanomeline High Dose" ~ 2,
#     TRUE ~ 99
#   )}

format_armn <- function(x) {
  case_when(
    x=="Placebo" ~ 0,
    x=="Xanomeline Low Dose" ~ 54,
    x=="Xanomeline High Dose" ~ 81,
    TRUE ~ 99
  )
}


  
format_trt01pn <- function(x) {
  case_when(
    x =="Placebo" ~ 0,
    x =="Xanomeline Low Dose" ~ 54,
    x =="Xanomeline High Dose" ~ 81,
    TRUE ~ 99
  )}

```


visit num flag function (Kyle & Martha)

```{r}


flag_n <- function(n, df) {
  
sv_n = sv %>% 
  
  filter(VISITNUM == n) %>% 
  
  select(USUBJID,
         
         SVSTDTC)

# combine these vist n IDS with main datset

adsl_n = merge(df,
               
               sv_n) %>% 
  
  mutate(
    
    COMPnFL = case_when(
      
      as.Date(RFENDTC) >= as.Date(SVSTDTC) ~ "Y",
      
      as.Date(RFENDTC) < as.Date(SVSTDTC) ~ "N"
      
      ),
    
    date_diff = as.Date(RFENDTC) - as.Date(SVSTDTC)) 


adsl_n_N = df %>% 
  
  filter(!(df$USUBJID %in% adsl_n$USUBJID)) %>% 
  
  mutate(COMPnFL = "N")

# add the non-visit 12 pts to visit 12 pts

adsl_n_all = rbind((adsl_n %>% select(-SVSTDTC, -date_diff)),
                   
                   adsl_n_N) 

return(adsl_n_all)


  }

```




```{r call in SDTM data}

# Read in input SDTM data 
data("admiral_dm")
data("admiral_ex")

dm <- read_xpt("sdtm/dm.xpt")
ds <- read_xpt("sdtm/ds.xpt")
ex <- read_xpt("sdtm/ex.xpt")
vs <- read_xpt("sdtm/vs.xpt")
qs <- read_xpt("sdtm/qs.xpt")
mh <- read_xpt("sdtm/mh.xpt")
sv <- read_xpt("sdtm/sv.xpt")
sc <- read_xpt("sdtm/sc.xpt")

my_spec <- read_xlsx("metadata/specs.xlsx", sheet = "Codelists")



```

adapting compxxfl function from adsl_spidey2


```{r}

COMPxxFL <- function(sv, adsl, visitnum, xx){

sv %>%
  filter(VISITNUM == visitnum) %>%
  select(USUBJID, SVSTDTC, VISITNUM) %>% 
  full_join(., adsl, by ="USUBJID") %>%
  mutate(SVSTDTC = SVSTDTC %>% ymd, RFENDTC = RFENDTC %>% ymd) %>%
  mutate(aux = if_else(VISITNUM == visitnum & RFENDTC>=SVSTDTC,"Y","N")) %>%
  mutate(!!paste0("COMP", xx, "FL") := ifelse(is.na(aux),"N","Y")) %>%
  select(USUBJID, !!paste0("COMP", xx, "FL")) %>%
  arrange(., USUBJID) 
  
}

```


```{r}

THISTHAT <- function(adsl, domain, output, input, condition.var, condition.val){
  
  full_join(adsl,
            
            domain %>% select(USUBJID, input, condition.var) %>%
              
              filter(get(condition.var) == condition.val) %>%
              
              select(USUBJID, input),
            
            by = "USUBJID") %>%
    
    rename(!!output := input) %>% 
    
    select(USUBJID, output)
  
}
  
  
```


```{r}

# COMPxxFL(sv, adsl.all, 8, 8)

```


```{r}
# build adsl from scratch -------------------------------------------------


adsl_dm <- dm %>%
  
  select(AGE,
         AGEU,
         ARM,
         DTHFL,
         ETHNIC,
         RACE,
         RFENDTC,
         RFSTDTC,
         SEX,
         SITEID,
         STUDYID,
         SUBJID,
         USUBJID) %>%
  
  mutate(ARMN = format_armn(ARM),
         
         TRT01PN = format_trt01pn(ARM))
```


*DCDECOD*

DS.DSDECOD where DSCAT='DISPOSITION EVENT'

```{r}



ds.DCDECOD = ds %>%
  
  filter(DSCAT == "DISPOSITION EVENT") %>% 
  
  select(USUBJID, DSDECOD )

adsl.DCDECOD = merge(adsl_dm,
                   
                   ds.DCDECOD) %>% 
  
  rename(DCDECOD = DSDECOD)

adsl.DCDECOD


adsl_dm = adsl.DCDECOD
```


*DCSREAS*

I think this is just the lower case version (first letter capital) of DCDECOD

```{r}

adsl.DCSREAS = adsl_dm %>%
  
  mutate(DSCREAS = str_to_title(adsl_dm$DCDECOD))

adsl.DCSREAS

adsl_dm = adsl.DCSREAS

```


*DISCONFL*

Y_Blank type (Y or NULL)

Y if DCREASCD != 'Completed'. Null otherwise
--> this should be "DCREAS" in the current adsl variables

(the spec order didn't make sense; DCDECOD and DCREAS should come first...)


```{r}

adsl.DISCONFL = adsl_dm %>% 
  
  mutate(
    
    DISCONFL = case_when(
      
      DSCREAS != "Completed" ~ "Y",
      
      TRUE ~ ""
      
      )
    
    )

adsl.DISCONFL

adsl_dm = adsl.DISCONFL

```

**
Before TRTEDT, first check the last date of the discontinuation (if so)

```{r}

adsl.DISCDT <-
  ds %>% 
  
  filter(DSDECOD != "COMPLETED") %>%    # subject discontinued
  
  group_by( USUBJID ) %>%
  
  slice(n()) %>%                        # last date since there are more than 1 rec per sub
  
  mutate(DSVNUM=VISITNUM) %>%           # rename visitnum to use it in TRTDUR
  
  select(USUBJID, DSSTDTC, DSVNUM)     


adsl_dm = merge(adsl_dm,
                 
                 adsl.DISCDT)
```



*TRTEDT*

The date of final dose (from the CRF) is EX.EXENDTC on the subject's last EX record.

If the date of final dose is missing for the subject *and* the subject discontinued after visit 3,
use the date of discontinuation as the date of last dose. Convert the date to a SAS date.

```{r}

#merge in with EX

adsl.EXENDTC <- ex %>% 
  
  select(USUBJID, EXENDTC)


adsl_dm = merge(adsl_dm,
                 
                 adsl.EXENDTC)


adsl.TRTEDT <- adsl_dm %>% 
  mutate(TRTEDT =
  case_when (
    
            EXENDTC == NA_character_ & DSVNUM > 3 ~  as.Date(DSSTDTC) , # DISC subs
      
            TRUE ~ as.Date(EXENDTC)
           )
        )



adsl_dm = merge(adsl_dm,
                 
                 adsl.TRTEDT)

```



*TRTDUR* 


```{r}

# calculate treatment duration --------------------------------------------

# get start date

sv_3 = sv %>% 
  
  filter(VISITNUM == 3)

# get end date

ex_last.0 = ex %>% 
  
  group_by(USUBJID) %>% 
  
  arrange(as.Date(EXENDTC)) %>%
  
  slice(n())

ex_last.1 = ex %>% 
  
  group_by(USUBJID) %>% 
  
  arrange(as.Date(EXSTDTC)) %>%
  
  slice(n())

# check if last date worked

dim(ex_last)

# try to merge the df 's

# dur_df = merge(x = (sv_3 %>% select(USUBJID, SVSTDTC)),
#                
#                y = (ex_last %>% select(USUBJID, EXENDTC)),
#                
#                by.x = sv_3$USUBJID)
          

# let's hack it instead

sv_3_id = sv_3 %>% 
  
  arrange(USUBJID) %>% 
  
  select(USUBJID,
         
         SVSTDTC)

ex_last_id = ex_last %>% 
  
  arrange(USUBJID) %>% 
  
  select(USUBJID,
         
         EXENDTC)

# merge and get trtdur per ID:

dur_df = merge(sv_3_id,
               
               ex_last_id) %>% 
  
  mutate(
    
    TRTDUR = as.Date(EXENDTC) - as.Date(SVSTDTC) + 1
    
    )


```


```{r}
# combine adsl with treatment duration

adsl_dur = merge(adsl_dm,
                 
                 dur_df)

# output didn't give same number of IDs as adsl, which don't match?

difference = setdiff(adsl_dm$USUBJID,
                     
                     dur_df$USUBJID)


adsl_match = adsl_dm %>% 
  
  filter(ARM != "Screen Failure")


# follow up with Martha, Monday -------------------------------------------
# merge the 254 that match, then tack back on the remainder

adsl_dur = merge(adsl_match,
                 
                 dur_df)

# the remainder are all screen failures
# let's just add empty variables for them, and then rbind


adsl_SF = adsl_dm %>% 
  
  filter(ARM == "Screen Failure") %>% 
  
  mutate(SVSTDTC = NA,
         EXENDTC = NA,
         TRTDUR = NA
         )


# rbind it all together

adsl_trtdur = rbind(adsl_dur,
                    
                    adsl_SF) 


```



```{r}
# pick back up on monday: add more variables in order? ------------------

adsl_order = adsl_trtdur %>% 
  
  select(STUDYID,
         USUBJID,
         SUBJID,
         SITEID,
         # SITEGR1,
         ARM,
         # TRT01P,
         TRT01PN,
         # TRT01A,
         # TRT01AN,
         TRTSDT = SVSTDTC,
         TRTEDT = EXENDTC,
         TRTDURD = TRTDUR,
         # AVGDD
         # CUMDOSE
         AGE,
         # AGEGR1
         # AGEGR1N
         AGEU,
         RACE,
         # RACEN
         SEX,
         ETHNIC,
         #...
         DTHFL,
         #...
         RFSTDTC,
         RFENDTC
         )
```




```{r}
# SITEGR1
# Sites are pooled if there are fewer than 3 patients per site

# check num patients per site

site_pool_n = adsl_order %>% 
  
  group_by(SITEID) %>% 
  
  count() %>% 
  
  arrange(n) %>% 
  
  mutate(
    
    SITEGR1 = case_when (
      
      n < 3 ~ as.character(paste(900)),
      
      TRUE ~ SITEID
      
      )) %>% 
  
  ungroup()


# we need to add the next lowest site to the pool to increase n to >= 3
# but we will not deal with programming it right now
# let's combine SITEGR1 with the pooled group code

adsl.all = merge(adsl_order,
                 
                 site_pool_n)

# let's try the same thing but easier with admiral? 

adsl_alt = adsl_order %>% 
  
  derive_vars_merged(
    
    dataset_add = site_pool_n,
    new_vars = vars(SITEGR1 = SITEGR1),
    by_vars = vars(SITEID)
    
    )
```


```{r}
# TRT01P
# apparently this is just DM.ARM ? 

adsl.all = adsl.all %>% 
  
  mutate(TRT01P = ARM,
         
         .after = ARM)

# TRT01A
# this is the actual treatment, which is the same as planned in this study

adsl.all = adsl.all %>% 
  
  mutate(TRT01A = TRT01P,
         
         .after = TRT01PN)

# TRT01AN
# this is the actual treatment, which is the same as planned in this study
# codelist for ARMN specifies this means "0, 54, 81"

adsl.all = adsl.all %>% 
  
  mutate(TRT01AN = TRT01PN,
         
         .after = TRT01A)
```


```{r}
# AGEGR1
# AGEGR1 = 1 if AGE <65. AGEGR1 = 2 if AGE 65-80. AGEGR1 = 3 if AGE >80

adsl.all = adsl.all %>% 
  
  mutate(AGEGR1 = case_when(
    
    AGE < 65 ~ "AGE <65",
    AGE >= 65 & AGE <= 80 ~ "AGE 65-80",
    AGE > 80 ~ "AGE >80"
    
  ),
  
  .after = AGE)


# AGEGR1N
# AGEGR1 = 1 if AGE <65. AGEGR1 = 2 if AGE 65-80. AGEGR1 = 3 if AGE >80

adsl.all = adsl.all %>% 
  
  mutate(AGEGR1N = case_when(
    
    AGEGR1 == "AGE <65" ~ 1,
    AGEGR1 == "AGE 65-80" ~ 2,
    AGEGR1 == "AGE >80" ~ 3
    
  ),
  
  .after = AGEGR1)
```


```{r}

# RACEN 

adsl.all = adsl.all %>% 
  
  mutate(RACEN = format_racen(RACE),

        .after = RACE )



```


ITTFL

"Y if ARMCD ne ' '. N otherwise"

```{r}

adsl.all = adsl.all %>% 
  
  mutate(ITTFL = case_when(
    
    ARM != "Screen Failure" ~ "Y",
    
    TRUE ~ "N"
    
  ),
  
  .after = ETHNIC)

```

SAFFL

"'Y' if ITTFL='Y' and TRTSDT ne missing. 'N' otherwise"

```{r}

adsl.all = adsl.all %>% 
  
  mutate(SAFFL = case_when(
    
    ITTFL == "Y" & !is.na(TRTSDT) ~ "Y",
    
    ITTFL == "N" ~ "N"
    
  ),
  
  .after = ITTFL)

```


*EFFFL*

'Y' if SAFFL='Y' 
AND subject has at least one record in QS for 'ADAS-Cog' with VISITNUM > 3 
AND at least one record in QS for 'CIBIC+' with VISITNUM > 3,
'N' otherwise


First, let's check qs...

```{r}

qs <- read_xpt("sdtm/qs.xpt")

```

let's figure out which patients had CIBIC and ADAS-Cog scores

```{r}

# CIBIC

CIBIC = qs %>% 
  
  arrange(VISITNUM) %>% 
  
  filter(QSTESTCD == "CIBIC") %>% 
  
  group_by(USUBJID) %>% 
  
  slice(n()) %>% 
  
  ungroup()

```

```{r}

# ADAS

ADAS = qs %>% 
  
  arrange(VISITNUM) %>% 
  
  filter(str_detect(QSTEST, "ADAS-COG")) %>% 
  
  group_by(USUBJID) %>% 
  
  slice(n()) %>% 
  
  ungroup()

```

find overlap in subjects between CIBIC and ACOG
then, confirm they have visitnum > 3

```{r}

# which IDs don't match both?

# this gives FALSE if the USUBJID does not have both ADAS and CIBIC

difference_ADAS = ADAS %>% 
  
  mutate(common = ADAS$USUBJID %in% CIBIC$USUBJID) %>% 
  
  filter(common == "TRUE",
         
         VISITNUM > 3) %>% 
  
  select(USUBJID) %>% 
  
  mutate(EFFFL = "Y")

```


now, merge ADAS + CIBIC patients with full data
and filter for SAFFL is Y

```{r}

EFFFL_Y = merge(adsl.all,
      
      difference_ADAS) %>% 
  
  filter(SAFFL == "Y")

```

these are all the patients for EFFFL
so, filter these out of the original dataset and set all others to "N"
then rbind back together!

```{r}

EFFFL_N = adsl.all %>% 
  
  filter(!(adsl.all$USUBJID %in% EFFFL_Y$USUBJID)) %>% 
  
  mutate(EFFFL = "N")

```


```{r}

adsl_EFFFL = rbind(EFFFL_Y,
                   EFFFL_N)

adsl_EFFFL

adsl.all = adsl_EFFFL

```


let's test flag_n? 

```{r}

flag_n(9, adsl.all) %>% 
  
  mutate(COMP9FL = COMPnFL) %>% 
  
  select(-COMPnFL)

```

*COMP8FL - COMP24FL*

'Y' if subject has a SV.VISITNUM=8 and RFENDTC >= date of visit 8 (SV.SVSTDTC), 'N' otherwise

try this with flag_n() function

```{r}

adsl_comp8 = flag_n(8, adsl.all) %>% 
  
  rename(COMP8FL = COMPnFL)

adsl_comp16 = flag_n(10, adsl_comp8) %>% 
  
  rename(COMP16FL = COMPnFL)

adsl_comp24 = flag_n(12, adsl_comp16) %>% 
  
  rename(COMP24FL = COMPnFL)


adsl.all = adsl_comp24

```

*COMP8FL manual*

this is the basis of the "flag_n()" function

```{r}
sv8 = sv %>% 
  
  filter(VISITNUM == 8) %>% 
  
  select(USUBJID,
         
         SVSTDTC)

sv8

```


```{r}
# combine these vist 8 IDS with main datset

adsl_8 = merge(adsl_EFFFL,
               
               sv8) %>% 
  
  mutate(
    
    COMP8FL = case_when(
      
      as.Date(RFENDTC) >= as.Date(SVSTDTC) ~ "Y",
      
      as.Date(RFENDTC) < as.Date(SVSTDTC) ~ "N"
      
      ),
    
    date_diff = as.Date(RFENDTC) - as.Date(SVSTDTC))

adsl_8

```


```{r}
str(adsl_8)

unique(adsl_8$COMP8FL)

min(adsl_8$date_diff)

# all vist 8 pts had the right date condition, so all are yes
# let's add back the non-vist 8 pts with the %in% strategy...

```


```{r}

adsl_8_N = adsl_EFFFL %>% 
  
  filter(!(adsl_EFFFL$USUBJID %in% adsl_8$USUBJID)) %>% 
  
  mutate(COMP8FL = "N")

# add the non-visit 8 pts to visit 8 pts

adsl_8_all = rbind((adsl_8 %>% select(-SVSTDTC, -date_diff)),
                   
                   adsl_8_N)

adsl_8_all

# adsl.all = adsl_8_all

```
```{r}

adsl_8_all$COMP8FL %>% table()

```


*COMP16FL manual*

copying and pasting comp8fl code block

'Y' if subject has a SV.VISITNUM=16 and RFENDTC >= date of visit *10* (SV.SVSTDTC), 'N' otherwise


```{r}

sv10 = sv %>% 
  
  filter(VISITNUM == 10) %>% 
  
  select(USUBJID,
         
         SVSTDTC)

# combine these vist 10 IDS with main datset

adsl_10 = merge(adsl.all,
               
               sv10) %>% 
  
  mutate(
    
    COMP16FL = case_when(
      
      as.Date(RFENDTC) >= as.Date(SVSTDTC) ~ "Y",
      
      as.Date(RFENDTC) < as.Date(SVSTDTC) ~ "N"
      
      ),
    
    date_diff = as.Date(RFENDTC) - as.Date(SVSTDTC)) 

str(adsl_10)

unique(adsl_10$COMP16FL)

min(adsl_10$date_diff)

# all vist 10 pts had the right date condition, so all are yes
# let's add back the non-vist 10 pts with the %in% strategy...

adsl_10_N = adsl.all %>% 
  
  filter(!(adsl.all$USUBJID %in% adsl_10$USUBJID)) %>% 
  
  mutate(COMP16FL = "N")

# add the non-visit 10 pts to visit 10 pts

adsl_10_all = rbind((adsl_10 %>% select(-SVSTDTC, -date_diff)),
                   adsl_10_N)

adsl_10_all

# adsl.all = adsl_10_all

```



*COMP24FL manual*

copying and pasting comp8fl code block

'Y' if subject has a SV.VISITNUM=24 and RFENDTC >= date of visit *12* (SV.SVSTDTC), 'N' otherwise


```{r}

sv12 = sv %>% 
  
  filter(VISITNUM == 12) %>% 
  
  select(USUBJID,
         
         SVSTDTC)

# combine these vist 12 IDS with main datset

adsl_12 = merge(adsl.all,
               
               sv12) %>% 
  
  mutate(
    
    COMP24FL = case_when(
      
      as.Date(RFENDTC) >= as.Date(SVSTDTC) ~ "Y",
      
      as.Date(RFENDTC) < as.Date(SVSTDTC) ~ "N"
      
      ),
    
    date_diff = as.Date(RFENDTC) - as.Date(SVSTDTC)) 

str(adsl_12)

unique(adsl_12$COMP24FL)

min(adsl_12$date_diff)

# all vist 12 pts had the right date condition, so all are yes
# let's add back the non-vist 12 pts with the %in% strategy...

adsl_12_N = adsl.all %>% 
  
  filter(!(adsl.all$USUBJID %in% adsl_12$USUBJID)) %>% 
  
  mutate(COMP24FL = "N")

# add the non-visit 12 pts to visit 12 pts

adsl_12_all = rbind((adsl_12 %>% select(-SVSTDTC, -date_diff)),
                   adsl_12_N)

adsl_12_all

# adsl.all = adsl_12_all

```


*DSRAEFL*

Y if DCREASCD='Adverse Event'. Null otherwise

```{r}

adsl.DSRAEFL = adsl.all %>% 
  
  mutate(
    
    DSRAEFL = case_when(
      
      DSCREAS == "Adverse Event" ~ "Y",
      
      TRUE ~ ""
      
      )
    
    )

adsl.DSRAEFL

adsl.all = adsl.DSRAEFL


```



*DTHFL*

description is just "DM.DTHFL"

```{r}

dm.DTHFL = dm %>% 
  
  select(USUBJID,
         
         DTHFL)

adsl.DTHFL = merge(adsl.all,
                   
                   dm.DTHFL) %>% 
  
  mutate(DTHFL2 = DTHFL,
         
         .after = DSRAEFL) %>% 
  
  select(-DTHFL) %>% 
  
  rename(DTHFL = DTHFL2)

adsl.DTHFL

adsl.all = adsl.DTHFL

```


*Checking flag output!*

```{r}

adsl.all

```

*HEIGHTBL*

VSSTRESN when VS.VSTESTCD='HEIGHT' and VS.VISITNUM=1

Otherwise, let's make it "" ? 


```{r}

vs.HEIGHTBL = vs %>% 
  
  filter(VSTESTCD == "HEIGHT" & VISITNUM == 1) %>% 
  
  select(USUBJID,
         
         VSSTRESN) %>% 
  
  mutate(HEIGHTBL = VSSTRESN) %>% 
  
  select(-VSSTRESN)

adsl.SF.HEIGHTBL = adsl.all %>% 
  
  filter(str_detect(ARM, "Screen Failure")) %>% 
  
  mutate(HEIGHTBL = "")

adsl.HEIGHTBL.pre = merge(adsl.all,
                      
                      vs.HEIGHTBL)

adsl.HEIGHTBL = rbind(adsl.HEIGHTBL.pre,
                      
                      adsl.SF.HEIGHTBL)

adsl.HEIGHTBL

adsl.all = adsl.HEIGHTBL

```



*WEIGHTBL*

*FIXED: ONE PT WITHDREW BETWEEN VISITS 1 AND 3*

filtered with %in% of the visit3 pts, and made the remainder "" for this


VSSTRESN when VS.VSTESTCD='WEIGHT' and VS.VISITNUM=3

Otherwise, let's make it ""


```{r}

vs.WEIGHTBL = vs %>% 
  
  filter(VSTESTCD == "WEIGHT" & VISITNUM == 3) %>% 
  
  select(USUBJID,
         
         VSSTRESN) %>% 
  
  mutate(WEIGHTBL = VSSTRESN) %>% 
  
  select(-VSSTRESN)


adsl.SF.WEIGHTBL = adsl.all %>% 
  
  filter(!(USUBJID %in% vs.WEIGHTBL$USUBJID)) %>% 
  
    mutate(WEIGHTBL = "")


adsl.WEIGHTBL.pre = merge(adsl.all,
                      
                      vs.WEIGHTBL)

adsl.WEIGHTBL = rbind(adsl.WEIGHTBL.pre,
                      
                      adsl.SF.WEIGHTBL)

adsl.WEIGHTBL

adsl.all = adsl.WEIGHTBL

```



*BMIBL*

WEIGHTBL / ((HEIGHTBL/100)**2)

```{r}

adsl.BMIBL = adsl.all %>% 
  
  mutate(BMIBL = (as.numeric(paste(WEIGHTBL))) / ((as.numeric(paste(HEIGHTBL))) / 100)^2)

adsl.BMIBL

adsl.all = adsl.BMIBL

```


*BMIBLGR1*

"BMIBLGR1=""<25"" if . < BMIBL <25.
BMIBLGR1=""25-<30"" if 25 <=BMIBL <30.
BMIBLGR1="">=30""if BMIBL >=30."


```{r}

adsl.BMIBLGR1 = adsl.all %>% 
  
  mutate(BMIBLGR1 = case_when(
    
    BMIBL < 25 ~ "<25",
    BMIBL >= 25 & BMIBL <30 ~ "25-<30",
    BMIBL >= 30 ~ ">=30"
    
  ))

adsl.BMIBLGR1

adsl.all = adsl.BMIBLGR1

```


writing new function right quick

(moved to top, this chunk was for testing)


```{r}
# adsl = adsl.all
# 
# domain = sv
# 
# output = "VISIT1DT"
# 
# input = "SVSTDTC"
# 
# condition.var = "VISITNUM"
# 
# condition.val = 1
```



*EDUCLVL*

SC.SCSTRESN where SC.SCTESTCD=EDLEVEL


```{r}



THISTHAT(adsl, sc, "EDUCLVL", "SCSTRESN", "SCTESTCD", "EDLEVEL")

```

*DISONSDT*

MH.MHSTDTC where MHCAT='PRIMARY DIAGNOSIS' converted to SAS date


```{r}

THISTHAT(adsl, mh, "DISONSDT", "MHSTDTC", "MHCAT", "PRIMARY DIAGNOSIS")
```


*VISIT1DT*

SV.SVSTDTC when SV.VISITNUM=1, converted to SAS date


```{r}

THISTHAT(adsl, sv, "VISIT1DT", "SVSTDTC", "VISITNUM", 1)


```


*EDUCLVL*

SC.SCSTRESN where SC.SCTESTCD=EDLEVEL

```{r}

adsl.educlvl <- full_join(adsl.all,
                          
                          sc %>% filter(SCTESTCD == "EDLEVEL") %>% select(USUBJID, SCSTRESN),
                          
                          by = "USUBJID") %>%
  
  rename(EDUCLVL = SCSTRESN)

adsl.educlvl

adsl.all <- adsl.educlvl

```

*DISONSDT*

MH.MHSTDTC where MHCAT='PRIMARY DIAGNOSIS' converted to SAS date

```{r}

adsl.disonsdt <- full_join(adsl.all,
                          
                          mh %>% filter(MHCAT == "PRIMARY DIAGNOSIS") %>% select(USUBJID, MHSTDTC),
                          
                          by = "USUBJID") %>%
  
  rename(DISONSDT = MHSTDTC)

adsl.disonsdt

adsl.all <- adsl.disonsdt

```


*VISIT1DT*

SV.SVSTDTC when SV.VISITNUM=1, converted to SAS date

```{r}

adsl.VISIT1DT <- full_join(adsl.all,
                          
                          sv %>% filter(VISITNUM == 1) %>% select(USUBJID, SVSTDTC),
                          
                          by = "USUBJID") %>%
  
  rename(VISIT1DT = SVSTDTC)

adsl.VISIT1DT

adsl.all <- adsl.VISIT1DT

```


*DURDIS*

Number of months between VISIT1DT and DISONSDT

```{r}

adsl.durdis <- adsl.all %>% 
  
  mutate(DURDIS = round(time_length(VISIT1DT %>% ymd - DISONSDT %>% ymd, unit = "months"), digits = 1))

adsl.durdis

adsl.all = adsl.durdis
```


*DURDSGR1*

grouping DURDIS values as <12 and >=12

```{r}

adsl.durdsgr1 <- adsl.all %>% 
  
  mutate(DURDSGR1 = case_when(
    
    DURDIS < 12 ~ "<12",
    DURDIS >= 12 ~ ">=12"
    
  ))

adsl.durdsgr1

adsl.all = adsl.durdsgr1

```

*ARMN*

```{r}

# let's work from ARMN in adsl...

adsl.ARMN = adsl.all %>% 
  
  mutate(ARMN = format_armn(ARM))

```

*CUMDOSE*

For ARMN=0 or 1: CUMDOSE= TRT01PN*TRTDUR. 

--- For ARMN=2: CUMDOSE will be based on:

1. 54mg per day for the # of days subj was
in 1st dosing interval 

(i.e., visit4date-TRTSDT+1 if 1st interval completed,
TRTEDT-TRTSDT+1 if subj discontinued <=visit 4 and > visit 3), 

2. 81mg per day for the # of days subj was in 2nd dosing interval

(i.e., visit12date-visit4date if 2nd interval completed,
TRTEDT-visit4date if subj discontinued <= visit 12 and > visit 4) 

3. 54mg per day for the # of days subj was in 3rd dosing interval
(i.e., TRTEDT - visit12date if subj continued after visit 12).


... need to compute based on visit dates (by USUBJID)


```{r}

adsl.ARMN %>% 
  
  mutate(CUMDOSE = case_when(
    
    ARMN == 0 | ARMN == 51 ~ TRT01PN*TRTDUR,
    
    ARMN == 99 ~ NA,
    
    ARMN == 81 ~ 
    
  ))

```

*some TREDT and TRTDUR are missing values (not NA). Need to check why.*


*AVGDD*

Programming this depends on CUMDOSE...

CUMDOSE/TRTDURD


```{r}






```


*EOSSTT*

COMPLETED if ADSL.DCDECOD='COMPLETED'. DISCONTINUED if ADSL.DCDECOD not equal to COMPLETED.


```{r}



```



*MMSETOT*

Sum of QS.QSORRES values for the subject when QSCAT = MINI-MENTAL STATE

```{r}



```




For Martha: You can click the arrow to the left to "collapse" the chunks below.

```{r}


##auxiliar DS

#auxiliar dates

#MH

mh_disons <- mh %>%
  
  filter(MHCAT=="PRIMARY DIAGNOSIS") %>%
  
  derive_vars_dt(
    dtc = MHSTDTC,
    new_vars_prefix = "DISONS"
  )

#SV

sv_trtsdt <- sv %>%
  
  filter(VISITNUM==3) %>%
  
  derive_vars_dt(
    dtc = SVSTDTC,
    new_vars_prefix = "TRTS"
  )


#qsorres auxiliar (char to int)

qsorres <- qs %>%
  
  filter(QSCAT == "MINI-MENTAL STATE") %>%
  
  mutate_all(type.convert, as.is=TRUE)


adsl <- dm %>%
  
  #Predecesor DM variables (no computation)
  
  select (AGE,
          AGEU,
          ARM,
          DTHFL,
          ETHNIC,
          RACE,
          RFENDTC,
          RFSTDTC,
          SEX,
          SITEID,
          STUDYID,
          SUBJID,
          ARMCD,
          USUBJID)

adsla <- adsl %>%
  
  derive_vars_merged(
    dataset_add = ds,
    by_vars = vars(STUDYID, USUBJID),
    new_vars = vars(VISNUM = VISITNUM),
    filter_add = DSTERM =="PROTCOL COMPLETED"
  ) %>%
  
  derive_vars_merged(
    dataset_add = ds,
    by_vars = vars(STUDYID, USUBJID),
    new_vars = vars(DCDECOD = DSDECOD),
    filter_add = DSCAT == "DISPOSITION EVENT"
  ) %>%
  
  derive_vars_merged(
    dataset_add = vs,
    by_vars = vars(STUDYID, USUBJID),
    new_vars = vars(WEIGHTBL = VSSTRESN),
    filter_add = (VSTESTCD=="WEIGHT" & VISITNUM==3 )
  ) %>%
  
  derive_vars_merged(
    dataset_add = vs,
    by_vars = vars(STUDYID, USUBJID),
    new_vars = vars(HEIGHTBL = VSSTRESN),
    filter_add = (VSTESTCD=="HEIGHT" & VISITNUM==1 )
  ) %>%
  
  derive_vars_merged(
    dataset_add = mh_disons,
    by_vars = vars(STUDYID, USUBJID),
    new_vars = vars(DISONSDT )
  ) %>%
  
  derive_vars_merged(
    dataset_add = sv_trtsdt,
    by_vars = vars(STUDYID, USUBJID),
    new_vars = vars(TRTSDT )
  ) %>%
  
  mutate(
    
    EOSSTT = format_eoxxstt_nodef(DCDECOD),
    
    RACEN = format_racen(RACE),
    
    ARMN = format_armn(ARM),
    
    AGEGR1N = format_agegr1n(AGE),
    
    AGEGR1 = format_agegr1(AGEGR1N),
    
    BMIBL = WEIGHTBL / ((HEIGHTBL/100)**2),
    
    VISNUMEN = format_visnumen (VISNUM),
    
    RFENDT = convert_dtc_to_dt(RFENDTC),
    
    TRT01P = ARM,
    
    TRT01A = TRT01P,
    
    TRT01PN = ARMN,
    
    TRT01AN = TRT01PN,
    
    ITTFL = if_else(ARMCD!="", "Y", "N"),
    
    SAFFL = if_else(ITTFL=="Y" & !is.na(TRTSDT) , "Y", "N")
    
  )  %>%
  
  derive_var_merged_summary(
    dataset_add = qsorres,
    by_vars = vars(STUDYID, USUBJID),
    filter_add = (QSCAT == "MINI-MENTAL STATE" & !is.na(QSORRES) ),
    new_var = MMSETOT,
    analysis_var = QSORRES,
    summary_fun =function(x) sum(x, na.rm = TRUE)
  )


```

```{r}

format_armn <- function(x) {
  case_when(
    x=="Placebo" ~ 0,
    x=="Xanomeline Low Dose" ~1,
    x=="Xanomeline High Dose" ~2,
    TRUE ~ 99
  )
}

format_trt01pn <- function(x) {
  case_when(
    x=="Placebo" ~ 0,
    x=="Xanomeline Low Dose" ~54,
    x=="Xanomeline High Dose" ~81,
    TRUE ~ 99
  )
}

adsl<-dm %>% select(AGE,
                    AGEU,
                    ARM,
                    DTHFL,
                    ETHNIC,
                    RACE,
                    RFENDTC,
                    RFSTDTC,
                    SEX,
                    SITEID,
                    STUDYID,
                    SUBJID,
                    USUBJID) %>%
  mutate(ARMN=format_armn(ARM),
         TRT01PN=format_trt01pn(ARM),
         TRTDUR=TRTEDT-TRTSDT+1) # %>%

```























